<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Dashboard S·ªë nh√† t·ªânh B·∫Øc Giang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .table-responsive { max-height: 400px; overflow-y: auto; }
    #barChart, #pieChart { background-color: white; border: 1px solid #ddd; padding: 10px; }
  </style>
</head>
<body class="container my-4">

  <h2 class="text-center mb-3">üìç DASHBOARD S·ªê NH√Ä TO√ÄN T·ªàNH B·∫ÆC GIANG</h2>
  <p class="text-center text-muted mb-4">C·∫≠p nh·∫≠t d·ªØ li·ªáu s·ªë h√≥a s·ªë nh√† qua JSON ƒë·ªông</p>

  <!-- 1. Khai b√°o mapping m√£ ‚Üí t√™n -->
  <script>
    // √Ånh x·∫° m√£ huy·ªán ‚Üí t√™n huy·ªán
    const districtMap = {
      "H02": "Hi·ªáp H√≤a",
      "H03": "T√¢n Y√™n",
      "H04": "Y√™n Th·∫ø",
      "H09": "L·∫°ng Giang"
      // ‚Ä¶ th√™m c√°c m√£/huy·ªán kh√°c n·∫øu c·∫ßn
    };

    // √Ånh x·∫° m√£ x√£/ph∆∞·ªùng ‚Üí t√™n x√£/ph∆∞·ªùng
    const wardMap = {
      "DP049": "TT. Cao Th∆∞·ª£ng",
      "DP061": "Ng·ªçc L√Ω",
      "DP071": "Vi·ªát L·∫≠p",
      "DP171": "ƒê·∫°i ƒê·ª©c"
      // ‚Ä¶ th√™m c√°c m√£/x√£ kh√°c n·∫øu c·∫ßn
    };
  </script>

  <!-- 2. T·ªïng quan to√†n t·ªânh (b·∫£ng) -->
  <h4>I. T·ªïng quan to√†n t·ªânh</h4>
  <table class="table table-bordered table-sm w-auto mb-4">
    <thead class="table-light">
      <tr><th>Ch·ªâ ti√™u</th><th>Gi√° tr·ªã</th><th>Ghi ch√∫</th></tr>
    </thead>
    <tbody id="summaryTableBody">
      <!-- D·ªØ li·ªáu s·∫Ω ƒë·ªï v√†o ƒë√¢y theo JavaScript -->
    </tbody>
  </table>

  <!-- 3. Bi·ªÉu ƒë·ªì so s√°nh v√† bi·ªÉu ƒë·ªì tr√≤n -->
  <div class="row mb-5">
    <div class="col-md-6">
      <h5 class="text-center">Bi·ªÉu ƒë·ªì c·ªôt: % Thi·∫øu CCCD theo huy·ªán</h5>
      <canvas id="barChart" width="400" height="300"></canvas>
    </div>
    <div class="col-md-6">
      <h5 class="text-center">Bi·ªÉu ƒë·ªì tr√≤n: T·ª∑ l·ªá thi·∫øu CCCD</h5>
      <canvas id="pieChart" width="400" height="300"></canvas>
    </div>
  </div>

  <!-- 4. B·ªô l·ªçc ƒë·ªông: Huy·ªán ‚Üí X√£/Ph∆∞·ªùng -->
  <h4>II. B·ªô l·ªçc ƒë·ªãa b√†n</h4>
  <div class="row mb-4">
    <div class="col-md-4 mb-2">
      <label for="huyenSelect" class="form-label">Ch·ªçn huy·ªán:</label>
      <select id="huyenSelect" class="form-select">
        <option value="all">T·∫•t c·∫£</option>
      </select>
    </div>
    <div class="col-md-4 mb-2">
      <label for="xaSelect" class="form-label">Ch·ªçn x√£/ph∆∞·ªùng:</label>
      <select id="xaSelect" class="form-select">
        <option value="all">T·∫•t c·∫£</option>
      </select>
    </div>
  </div>

  <!-- 5. B·∫£ng chi ti·∫øt theo x√£/ph∆∞·ªùng -->
  <h4>III. B·∫£ng chi ti·∫øt theo x√£/ph∆∞·ªùng</h4>
  <div class="table-responsive mb-4">
    <table id="detailTable" class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Huy·ªán</th><th>X√£/Ph∆∞·ªùng</th><th>T·ªïng s·ªë b·∫£n ghi</th>
          <th>Thi·∫øu CCCD</th><th>Thi·∫øu Ch·ªß h·ªô</th><th>Thi·∫øu c·∫£ hai</th><th>T·ª∑ l·ªá thi·∫øu CCCD (%)</th>
        </tr>
      </thead>
      <tbody id="detailTableBody">
        <!-- D·ªØ li·ªáu ƒë·ªông s·∫Ω ƒë·ªï v√†o ƒë√¢y -->
      </tbody>
      <tfoot class="table-light fw-bold">
        <tr>
          <td colspan="2">T·ªïng c·ªông</td>
          <td id="totalTongSo"></td>
          <td id="totalThieuCCCD"></td>
          <td id="totalThieuChuHo"></td>
          <td id="totalThieuCaHai"></td>
          <td id="totalTyLeThieuCCCD"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- 6. JavaScript hi·ªÉn th·ªã d·ªØ li·ªáu ƒë·ªông -->
  <script>
    let barChart, pieChart;

    fetch('data_sonha.json')
      .then(res => res.json())
      .then(data => {
        // 6.1. L·∫•y danh s√°ch m√£ huy·ªán duy nh·∫•t v√† mapping x√£
        const huyenSet = new Set();
        const xaTheoHuyen = {};
        data.forEach(item => {
          huyenSet.add(item.Huyen);
          if (!xaTheoHuyen[item.Huyen]) xaTheoHuyen[item.Huyen] = new Set();
          xaTheoHuyen[item.Huyen].add(item.XaPhuong);
        });
        const huyenList = Array.from(huyenSet);

        // 6.2. ƒêi·ªÅn dropdown Huy·ªán
        const huyenSelect = document.getElementById('huyenSelect');
        huyenList.forEach(code => {
          const opt = document.createElement('option');
          opt.value = code;
          opt.textContent = districtMap[code] || code;
          huyenSelect.appendChild(opt);
        });

        // 6.3. C·∫≠p nh·∫≠t dropdown X√£ khi ch·ªçn Huy·ªán
        function updateXaOptions() {
          const huyen = huyenSelect.value;
          const xaSelect = document.getElementById('xaSelect');
          xaSelect.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
          if (huyen !== 'all') {
            xaTheoHuyen[huyen].forEach(xaCode => {
              const opt = document.createElement('option');
              opt.value = xaCode;
              opt.textContent = wardMap[xaCode] || xaCode;
              xaSelect.appendChild(opt);
            });
          }
        }
        huyenSelect.addEventListener('change', () => {
          updateXaOptions();
          renderSummary();
          renderDetailTable();
          renderCharts();
        });
        document.getElementById('xaSelect').addEventListener('change', renderDetailTable);

        // 6.4. H√†m render T·ªïng quan
        function renderSummary() {
          const summaryBody = document.getElementById('summaryTableBody');
          summaryBody.innerHTML = '';
          const selectedHuyen = huyenSelect.value;
          let filtered = data;
          if (selectedHuyen !== 'all') {
            filtered = filtered.filter(d => d.Huyen === selectedHuyen);
          }
          const soXa = new Set(filtered.map(d => d.XaPhuong)).size;
          const tongHo = filtered.reduce((sum, d) => sum + d.TongSo, 0);
          const thieuCCCD = filtered.reduce((sum, d) => sum + d.ThieuCCCD, 0);
          const thieuChuHo = filtered.reduce((sum, d) => sum + d.ThieuChuHo, 0);
          const thieuCaHai = filtered.reduce((sum, d) => sum + d.ThieuCaHai, 0);
          const tyLe = tongHo ? ((thieuCCCD / tongHo) * 100).toFixed(1) + '%' : '0%';
          const rows = [
            ['S·ªë x√£/ph∆∞·ªùng ƒë√£ c√≥ d·ªØ li·ªáu', soXa, ''],
            ['T·ªïng s·ªë b·∫£n ghi', tongHo, ''],
            ['S·ªë b·∫£n ghi thi·∫øu CCCD', thieuCCCD, ''],
            ['S·ªë b·∫£n ghi thi·∫øu Ch·ªß h·ªô', thieuChuHo, ''],
            ['S·ªë b·∫£n ghi thi·∫øu c·∫£ hai', thieuCaHai, ''],
            ['T·ª∑ l·ªá thi·∫øu CCCD', tyLe, '']
          ];
          rows.forEach(r => {
            const tr = document.createElement('tr');
            r.forEach(val => {
              const td = document.createElement('td');
              td.textContent = val;
              tr.appendChild(td);
            });
            summaryBody.appendChild(tr);
          });
        }

        // 6.5. H√†m render B·∫£ng chi ti·∫øt
        function renderDetailTable() {
          const tbody = document.getElementById('detailTableBody');
          tbody.innerHTML = '';
          const selectedHuyen = huyenSelect.value;
          const selectedXa = document.getElementById('xaSelect').value;
          let filtered = data;
          if (selectedHuyen !== 'all') filtered = filtered.filter(d => d.Huyen === selectedHuyen);
          if (selectedXa !== 'all') filtered = filtered.filter(d => d.XaPhuong === selectedXa);

          let totalTongSo = 0, totalThieuCCCD = 0, totalThieuChuHo = 0, totalThieuCaHai = 0;
          filtered.forEach(d => {
            const tr = document.createElement('tr');
            const huyenName = districtMap[d.Huyen] || d.Huyen;
            const xaName    = wardMap[d.XaPhuong] || d.XaPhuong;
            [huyenName, xaName, d.TongSo, d.ThieuCCCD, d.ThieuChuHo, d.ThieuCaHai, d.TyLeThieuCCCD].forEach(val => {
              const td = document.createElement('td');
              td.textContent = val;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
            totalTongSo += d.TongSo;
            totalThieuCCCD += d.ThieuCCCD;
            totalThieuChuHo += d.ThieuChuHo;
            totalThieuCaHai += d.ThieuCaHai;
          });
          document.getElementById('totalTongSo').textContent = totalTongSo;
          document.getElementById('totalThieuCCCD').textContent = totalThieuCCCD;
          document.getElementById('totalThieuChuHo').textContent = totalThieuChuHo;
          document.getElementById('totalThieuCaHai').textContent = totalThieuCaHai;
          const tyLeTong = totalTongSo ? ((totalThieuCCCD / totalTongSo) * 100).toFixed(1) + '%' : '0%';
          document.getElementById('totalTyLeThieuCCCD').textContent = tyLeTong;
        }

        // 6.6. H√†m render Bi·ªÉu ƒë·ªì
        function renderCharts() {
          const selectedHuyen = huyenSelect.value;
          let filteredChart = data;
          if (selectedHuyen !== 'all') filteredChart = filteredChart.filter(d => d.Huyen === selectedHuyen);

          // Bar Chart: % Thi·∫øu CCCD theo huy·ªán
          const barData = Array.from(huyenSet).map(code => {
            const arr = data.filter(d => d.Huyen === code);
            const tong = arr.reduce((sum, d) => sum + d.TongSo, 0);
            const thieu = arr.reduce((sum, d) => sum + d.ThieuCCCD, 0);
            return tong ? ((thieu / tong) * 100).toFixed(1) : 0;
          });
          if (barChart) barChart.destroy();
          barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
              labels: Array.from(huyenSet).map(code => districtMap[code] || code),
              datasets: [{
                label: '% Thi·∫øu CCCD theo huy·ªán',
                data: barData,
                backgroundColor: '#0d6efd'
              }]
            },
            options: {
              scales: { y: { beginAtZero: true, max: 100 } }
            }
          });

          // Pie Chart: T·ª∑ l·ªá Thi·∫øu CCCD (to√†n t·ªânh ho·∫∑c theo huy·ªán)
          const total = filteredChart.reduce((sum, d) => sum + d.TongSo, 0);
          const totalThieu = filteredChart.reduce((sum, d) => sum + d.ThieuCCCD, 0);
          if (pieChart) pieChart.destroy();
          pieChart = new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
              labels: ['Thi·∫øu CCCD', 'ƒê·ªß CCCD'],
              datasets: [{
                data: [totalThieu, total - totalThieu],
                backgroundColor: ['#dc3545', '#198754']
              }]
            },
            options: {
              plugins: {
                title: {
                  display: true,
                  text: selectedHuyen === 'all'
                    ? 'T·ª∑ l·ªá thi·∫øu CCCD to√†n t·ªânh'
                    : 'T·ª∑ l·ªá thi·∫øu CCCD t·∫°i ' + (districtMap[selectedHuyen] || selectedHuyen)
                }
              }
            }
          });
        }

        // 6.7. Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        updateXaOptions();
        renderSummary();
        renderDetailTable();
        renderCharts();
      })
      .catch(err => console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err));
  </script>

</body>
</html>
